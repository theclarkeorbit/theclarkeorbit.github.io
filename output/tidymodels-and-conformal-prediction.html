<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>"Tidymodels and conformal prediction" - p. bhogale</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href=".//images/gravtar.jpg" rel="icon">

<link rel="canonical" href="./tidymodels-and-conformal-prediction.html">

        <meta name="author" content="pras" />
        <meta name="description" content="Reading material: The tidy modeling book The tidymodels blog on conformal regression The notes of Angelopoulos The notes of Tibshirani The book of Christoph Molnar The book of Valeriy Manokhin The package of Sussman et al. Getting some data We will look at Indian trade data hosted on Kaggle for …" />

        <meta property="og:site_name" content="p. bhogale" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="&#34;Tidymodels and conformal prediction&#34;"/>
        <meta property="og:url" content="./tidymodels-and-conformal-prediction.html"/>
        <meta property="og:description" content="Reading material: The tidy modeling book The tidymodels blog on conformal regression The notes of Angelopoulos The notes of Tibshirani The book of Christoph Molnar The book of Valeriy Manokhin The package of Sussman et al. Getting some data We will look at Indian trade data hosted on Kaggle for …"/>
        <meta property="article:published_time" content="2024-07-22" />
            <meta property="article:section" content="data_sci_tech" />
            <meta property="article:author" content="pras" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>

        <link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="p. bhogale ATOM Feed"/>

        <link href="./feeds/data_sci_tech.atom.xml" type="application/atom+xml" rel="alternate"
              title="p. bhogale data_sci_tech ATOM Feed"/>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115756026-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', UA-115756026-1);
    </script>
    <!-- End Google Analytics Code -->
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','');</script>
    <!-- End Google Tag Manager -->

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src=".//images/gravtar.jpg" width=""/> p. bhogale            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/about.html">
                             About
                          </a></li>
                        <li >
                            <a href="./category/blog.html">Blog</a>
                        </li>
                        <li class="active">
                            <a href="./category/data_sci_tech.html">Data_sci_tech</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<style>
	#banner{
	    background-image:url(".//images/banner.jpg");
	}
</style>

<div id="banner">
	<div class="container">
		<div class="copy">
			<h1>p. bhogale</h1>
				<p class="intro">Data Sci, Quant Fin, Quant Bio.</p>
		</div>
	</div>
</div><!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./tidymodels-and-conformal-prediction.html"
                       rel="bookmark"
                       title="Permalink to "Tidymodels and conformal prediction"">
                        "Tidymodels and conformal prediction"
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2024-07-22T00:00:00+02:00"> Mon 22 July 2024</time>
    </span>





    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h3>Reading material:</h3>
<ol>
<li><a href="https://www.tmwr.org/">The tidy modeling book</a></li>
<li><a href="https://www.tidymodels.org/learn/models/conformal-regression/">The tidymodels blog on conformal regression</a></li>
<li><a href="https://arxiv.org/abs/2107.07511">The notes of Angelopoulos</a></li>
<li><a href="https://www.stat.berkeley.edu/~ryantibs/statlearn-s23/lectures/conformal.pdf">The notes of Tibshirani</a></li>
<li><a href="https://christophmolnar.com/books/conformal-prediction/">The book of Christoph Molnar</a></li>
<li><a href="https://maven.com/valeriy-manokhin/applied-conformal-prediction">The book of Valeriy Manokhin</a></li>
<li><a href="https://github.com/herbps10/AdaptiveConformal">The package</a> of <a href="https://arxiv.org/abs/2312.00448">Sussman et al.</a></li>
</ol>
<h3>Getting some data</h3>
<p>We will look at <a href="https://www.kaggle.com/datasets/lakshyaag/india-trade-data">Indian trade data</a> hosted on Kaggle for the purposes of illustrating the tidy modeling techniques, without focusing too much on exploring the data.</p>
<div class="highlight"><pre><span></span><code>&lt;!--<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>kaggle<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>mkdir<span class="w"> </span>~/.datasets/india_trade_data<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>kaggle<span class="w"> </span>datasets<span class="w"> </span>download<span class="w"> </span>-d<span class="w"> </span>lakshyaag/india-trade-data<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>mv<span class="w"> </span>india-trade-data.zip<span class="w"> </span>~/.datasets/india_trade_data/<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>unzip<span class="w"> </span>-d<span class="w"> </span>~/.datasets/india_trade_data<span class="w"> </span>~/.datasets/india_trade_data/india-trade-data.zip<span class="w">  </span>--&gt;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="cp">## bash: -c: line 1: syntax error near unexpected token `newline&#39;</span>
<span class="cp">## bash: -c: line 1: `&lt;!-- pip install kaggle --&gt;&#39;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nf">read_csv</span><span class="p">(</span><span class="s">&quot;~/.datasets/india_trade_data/2010_2021_HS2_export.csv&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_exp</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Rows</span><span class="p">:</span><span class="w"> </span><span class="mi">184755</span><span class="w"> </span><span class="nx">Columns</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="err">##</span><span class="w"> </span><span class="err">──</span><span class="w"> </span><span class="nx">Column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="err">────────────────────────────────────────────────────────</span>
<span class="err">##</span><span class="w"> </span><span class="nx">Delimiter</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;,&quot;</span>
<span class="err">##</span><span class="w"> </span><span class="nx">chr</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="w"> </span><span class="nx">HSCode</span><span class="p">,</span><span class="w"> </span><span class="nx">Commodity</span><span class="p">,</span><span class="w"> </span><span class="nx">country</span>
<span class="err">##</span><span class="w"> </span><span class="nx">dbl</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">):</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">year</span>
<span class="err">##</span><span class="w"> </span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="err">`</span><span class="nx">spec</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">retrieve</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">full</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Specify</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="err">`</span><span class="nx">show_col_types</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">FALSE</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quiet</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nf">read_csv</span><span class="p">(</span><span class="s">&quot;~/.datasets/india_trade_data/2010_2021_HS2_import.csv&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_imp</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Rows</span><span class="p">:</span><span class="w"> </span><span class="mi">101051</span><span class="w"> </span><span class="nx">Columns</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="err">##</span><span class="w"> </span><span class="err">──</span><span class="w"> </span><span class="nx">Column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="err">────────────────────────────────────────────────────────</span>
<span class="err">##</span><span class="w"> </span><span class="nx">Delimiter</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;,&quot;</span>
<span class="err">##</span><span class="w"> </span><span class="nx">chr</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="w"> </span><span class="nx">HSCode</span><span class="p">,</span><span class="w"> </span><span class="nx">Commodity</span><span class="p">,</span><span class="w"> </span><span class="nx">country</span>
<span class="err">##</span><span class="w"> </span><span class="nx">dbl</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">):</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">year</span>
<span class="err">##</span><span class="w"> </span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="err">`</span><span class="nx">spec</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">retrieve</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">full</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Specify</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="err">`</span><span class="nx">show_col_types</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">FALSE</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quiet</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">df_hs2_exp</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">trade_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;export&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_exp</span>
<span class="n">df_hs2_imp</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">trade_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;import&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_imp</span>

<span class="n">df_hs2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">bind_rows</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">df_hs2_exp</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2_imp</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">    </span><span class="nf">is.na</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">    </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">value</span>
<span class="w">  </span><span class="p">),</span>
<span class="w">  </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
<span class="w">  </span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">    </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;U S A&quot;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;United states of America&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;U K&quot;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;United Kingdom&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">country</span>
<span class="w">  </span><span class="p">))</span>

<span class="n">indicators</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;gdp&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;NY.GDP.MKTP.CD&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># GDP in current dollars</span>
<span class="w">                </span><span class="s">&quot;population&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SP.POP.TOTL&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># population</span>
<span class="w">                </span><span class="s">&quot;land_area&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;EN.LAND.TOTL&quot;</span><span class="w"> </span><span class="c1"># total land</span>
<span class="w">                </span><span class="p">)</span>
<span class="nf">WDI</span><span class="p">(</span><span class="n">indicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">indicators</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2010</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2021</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">wb_df</span>

<span class="n">df_hs2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">country_name</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="o">=</span><span class="s">&quot;ISO3&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>##<span class="w"> </span><span class="nv">Some</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">IDs</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">match</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">more</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">requested</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">naming</span><span class="w"> </span><span class="nv">conventions</span>,<span class="w"> </span><span class="nv">NA</span><span class="w"> </span><span class="nv">returned</span>.
##<span class="w"> </span><span class="nv">Multiple</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">IDs</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">been</span><span class="w"> </span><span class="nv">matched</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">same</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">name</span>.
##<span class="w"> </span><span class="nv">There</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">low</span><span class="w"> </span><span class="nv">confidence</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">matching</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">some</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">names</span>,<span class="w"> </span><span class="nv">NA</span><span class="w"> </span><span class="nv">returned</span>.
##<span class="w"> </span>
##<span class="w"> </span><span class="nv">Set</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">verbose</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">TRUE</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">more</span><span class="w"> </span><span class="nv">details</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">left_join</span><span class="p">(</span><span class="n">df_hs2</span><span class="p">,</span><span class="w"> </span><span class="n">wb_df</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;iso3c&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;year&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="n">Commodity</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country.y</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">,</span><span class="w"> </span><span class="n">iso3c</span><span class="p">,</span><span class="w"> </span><span class="n">gdp</span><span class="p">,</span><span class="w"> </span><span class="n">population</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">group_by</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">summarise</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="n">gdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gdp</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">population</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">population</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">.groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;drop&quot;</span><span class="p">)</span>

<span class="nf">rm</span><span class="p">(</span><span class="n">df_exp</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2_exp</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2_imp</span><span class="p">,</span><span class="w"> </span><span class="n">df_imp</span><span class="p">,</span><span class="w"> </span><span class="n">wb_df</span><span class="p">)</span>
</code></pre></div>

<p>Just for simplicity, we will stick to the HS2 files (2010-2021), and ignore the other two (HS trade data) files that run from 2010-2018. We will combine the two files into a single data frame with an added column indicating direction of trade. We also interpret NAs in the <code>value</code> column to mean that there was no trade, and replace those with 0.</p>
<p>To make this something of a modelling challenge, we have enhanced the data with some information about the countries India is trading with, like the GDP. We downloaded GDP data from the World Bank with the <code>WDI</code> package. Then, we did a left join onto the Indian trade data on country and year, by first converting the countries in the Indian trade to their ISO3 codes via the <code>countries</code> package.</p>
<p>The data frame we now have will serve as the basis for us to explore tidy modeling and conformal prediction in R.</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">sample_n</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">## # A tibble: 10 × 6</span>
<span class="c1">##    country              year trade_direction   value           gdp population</span>
<span class="c1">##    &lt;chr&gt;               &lt;int&gt; &lt;chr&gt;             &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="c1">##  1 Burundi              2019 import             3.82   2576518880.   11874838</span>
<span class="c1">##  2 Trinidad and Tobago  2018 export            83.7   24569079488.    1504709</span>
<span class="c1">##  3 Belarus              2016 export            40.2   47723545321.    9469379</span>
<span class="c1">##  4 Romania              2020 export           372.   251362514350.   19265250</span>
<span class="c1">##  5 Bulgaria             2020 export           170.    70368758395.    6934015</span>
<span class="c1">##  6 North Macedonia      2019 export            22.6   12606338449.    1876262</span>
<span class="c1">##  7 Timor-Leste          2016 export             2.31   1652603700     1224562</span>
<span class="c1">##  8 Singapore            2013 import          6762.   307576360585.    5399162</span>
<span class="c1">##  9 Gambia, The          2010 import            14.7    1543294927.    1937275</span>
<span class="c1">## 10 Cote d&#39;Ivoire        2011 import           466.    36693710801.   21562914</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nf">ggplot</span><span class="p">({</span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">na.omit</span><span class="p">()},</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">value</span><span class="p">},</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_x_log10</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_tufte</span><span class="p">()</span>
</code></pre></div>

<p><img alt="center" src="/figures/tidymodconformal/unnamed-chunk-3-1.png"></p>
<h3>Tidy modeling in R</h3>
<p>Since the quantitative columns like <code>value</code>, <code>gdp</code> and <code>population</code> vary by orders of magnitude over the data, it probably makes sense to log transform them. To deal with 0 values, we add 1 to all the values, and omit rows which have any data missing.</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">na.omit</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">value</span><span class="m">+1</span><span class="p">),</span><span class="w"> </span><span class="n">gdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">gdp</span><span class="m">+1</span><span class="p">),</span><span class="w"> </span><span class="n">population</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">population</span><span class="m">+1</span><span class="p">))</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_modeling</span>
</code></pre></div>

<p>Now we split the data into training and test using built in functions from the <code>rsample</code> package, making sure that the distribution of the value column is similar in all our data splits using the strata argument. </p>
<div class="highlight"><pre><span></span><code><span class="nf">set.seed</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>

<span class="n">trade_split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">initial_validation_split</span><span class="p">({</span><span class="n">df_modeling</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nf">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">country</span><span class="p">)},</span><span class="w"> </span>
<span class="w">    </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.2</span><span class="p">),</span><span class="w"> </span><span class="n">strata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="n">trade_split</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>## &lt;Training/Validation/Testing/Total&gt;
## &lt;2856/952/952/4760&gt;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">train_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">training</span><span class="p">(</span><span class="n">trade_split</span><span class="p">)</span>
<span class="n">val_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">validation</span><span class="p">(</span><span class="n">trade_split</span><span class="p">)</span>
<span class="n">test_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">testing</span><span class="p">(</span><span class="n">trade_split</span><span class="p">)</span>
</code></pre></div>

<h4>Linear model</h4>
<p>As a first baseline, always best ton begin with a simple, interpretable linear model.</p>
<div class="highlight"><pre><span></span><code><span class="n">linear_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">linear_reg</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">set_engine</span><span class="p">(</span><span class="s">&quot;lm&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">fit</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">train_df</span><span class="p">)</span>

<span class="n">linear_fit</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">tidy</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">## # A tibble: 5 × 5</span>
<span class="c1">##   term                  estimate std.error statistic   p.value</span>
<span class="c1">##   &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="c1">## 1 (Intercept)           -47.8     16.0         -2.98 2.91e-  3</span>
<span class="c1">## 2 year                    0.0152   0.00796      1.91 5.66e-  2</span>
<span class="c1">## 3 trade_directionimport  -0.469    0.0545      -8.62 1.11e- 17</span>
<span class="c1">## 4 gdp                     0.666    0.0195      34.1  2.07e-214</span>
<span class="c1">## 5 population              0.396    0.0198      20.0  1.09e- 83</span>
</code></pre></div>

<p>Now, let us make some predictions on the validation data.</p>
<div class="highlight"><pre><span></span><code><span class="n">val_df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="nf">predict</span><span class="p">(</span><span class="n">linear_fit</span><span class="p">,</span><span class="w"> </span><span class="n">val_df</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="nf">predict</span><span class="p">(</span><span class="n">linear_fit</span><span class="p">,</span><span class="w"> </span><span class="n">val_df</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pred_int&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="c1"># 95% prediction intervals</span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">linear_preds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">,</span><span class="w"> </span>
<span class="w">         </span><span class="n">linear_pred_lower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_lower</span><span class="p">,</span>
<span class="w">         </span><span class="n">linear_pred_upper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_upper</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="m">-.</span><span class="n">pred</span><span class="p">,</span><span class="w"> </span><span class="m">-.</span><span class="n">pred_lower</span><span class="p">,</span><span class="w"> </span><span class="m">-.</span><span class="n">pred_upper</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">linear_residuals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">linear_preds</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">({</span><span class="n">val_df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">value</span><span class="p">)})</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">results_df</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linear_preds</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linear_preds</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">),</span><span class="w"> </span><span class="n">method</span><span class="o">=</span><span class="s">&quot;lm&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_tufte</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> `geom_smooth()` using formula = &#39;y ~ x&#39;
</code></pre></div>

<p><img alt="center" src="/figures/tidymodconformal/unnamed-chunk-7-1.png"></p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://www.linkedin.com/in/pbhogale"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://github.com/pbhogale"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./tidymodels-and-conformal-prediction.html">"Tidymodels and conformal prediction"</a></li>
    <li class="list-group-item"><a href="./r-torch-and-the-little-book-of-deep-learning.html">"R, Torch, and the little book of deep learning"</a></li>
    <li class="list-group-item"><a href="./becoming-a-data-scientist-an-opinionated-take-in-2020.html">"Becoming a Data Scientist : an opinionated take in 2020"</a></li>
    <li class="list-group-item"><a href="./linear-and-mixed-integer-programming.html">"Linear and mixed integer programming"</a></li>
    <li class="list-group-item"><a href="./the-invisible-hand.html">"The Invisible Hand"</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 pras
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>


    <script src="./theme/js/bodypadding.js"></script>


</body>
</html>