<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>"Tidymodels and conformal prediction" - p. bhogale</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href=".//images/gravtar.jpg" rel="icon">

<link rel="canonical" href="./tidymodels-and-conformal-prediction.html">

        <meta name="author" content="pras" />
        <meta name="description" content="Reading material: The tidy modeling book The tidymodels blog on conformal regression The notes of Angelopoulos The notes of Tibshirani The book of Christoph Molnar The book of Valeriy Manokhin The package of Sussman et al. Getting some data We will look at Indian trade data hosted on Kaggle for …" />

        <meta property="og:site_name" content="p. bhogale" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="&#34;Tidymodels and conformal prediction&#34;"/>
        <meta property="og:url" content="./tidymodels-and-conformal-prediction.html"/>
        <meta property="og:description" content="Reading material: The tidy modeling book The tidymodels blog on conformal regression The notes of Angelopoulos The notes of Tibshirani The book of Christoph Molnar The book of Valeriy Manokhin The package of Sussman et al. Getting some data We will look at Indian trade data hosted on Kaggle for …"/>
        <meta property="article:published_time" content="2024-07-22" />
            <meta property="article:section" content="data_sci_tech" />
            <meta property="article:author" content="pras" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>

        <link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="p. bhogale ATOM Feed"/>

        <link href="./feeds/data_sci_tech.atom.xml" type="application/atom+xml" rel="alternate"
              title="p. bhogale data_sci_tech ATOM Feed"/>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115756026-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', UA-115756026-1);
    </script>
    <!-- End Google Analytics Code -->
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','');</script>
    <!-- End Google Tag Manager -->

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src=".//images/gravtar.jpg" width=""/> p. bhogale            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/about.html">
                             About
                          </a></li>
                        <li >
                            <a href="./category/blog.html">Blog</a>
                        </li>
                        <li class="active">
                            <a href="./category/data_sci_tech.html">Data_sci_tech</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<style>
	#banner{
	    background-image:url(".//images/banner.jpg");
	}
</style>

<div id="banner">
	<div class="container">
		<div class="copy">
			<h1>p. bhogale</h1>
				<p class="intro">Data Sci, Quant Fin, Quant Bio.</p>
		</div>
	</div>
</div><!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./tidymodels-and-conformal-prediction.html"
                       rel="bookmark"
                       title="Permalink to "Tidymodels and conformal prediction"">
                        "Tidymodels and conformal prediction"
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2024-07-22T00:00:00+02:00"> Mon 22 July 2024</time>
    </span>





    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>Reading material:</h2>
<ol>
<li><a href="https://www.tmwr.org/">The tidy modeling book</a></li>
<li><a href="https://www.tidymodels.org/learn/models/conformal-regression/">The tidymodels blog on conformal
    regression</a></li>
<li><a href="https://arxiv.org/abs/2107.07511">The notes of Angelopoulos</a></li>
<li><a href="https://www.stat.berkeley.edu/~ryantibs/statlearn-s23/lectures/conformal.pdf">The notes of
    Tibshirani</a></li>
<li><a href="https://christophmolnar.com/books/conformal-prediction/">The book of Christoph
    Molnar</a></li>
<li><a href="https://maven.com/valeriy-manokhin/applied-conformal-prediction">The book of Valeriy
    Manokhin</a></li>
<li><a href="https://github.com/herbps10/AdaptiveConformal">The package</a> of
    <a href="https://arxiv.org/abs/2312.00448">Sussman et al.</a></li>
</ol>
<h2>Getting some data</h2>
<p>We will look at <a href="https://www.kaggle.com/datasets/lakshyaag/india-trade-data">Indian trade
data</a> hosted
on Kaggle for the purposes of illustrating the tidy modeling techniques,
without focusing too much on exploring the data.</p>
<div class="highlight"><pre><span></span><code>&lt;!--<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">kaggle</span><span class="o">==</span><span class="m">1</span>.6.14<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>mkdir<span class="w"> </span>~/.datasets/india_trade_data<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>kaggle<span class="w"> </span>datasets<span class="w"> </span>download<span class="w"> </span>-d<span class="w"> </span>lakshyaag/india-trade-data<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>mv<span class="w"> </span>india-trade-data.zip<span class="w"> </span>~/.datasets/india_trade_data/<span class="w"> </span>--&gt;
&lt;!--<span class="w"> </span>unzip<span class="w"> </span>-d<span class="w"> </span>~/.datasets/india_trade_data<span class="w"> </span>~/.datasets/india_trade_data/india-trade-data.zip<span class="w"> </span>--&gt;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="cp">## bash: -c: line 1: syntax error near unexpected token `newline&#39;</span>
<span class="cp">## bash: -c: line 1: `&lt;!-- pip install kaggle==1.6.14 --&gt;&#39;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nf">read_csv</span><span class="p">(</span><span class="s">&quot;~/.datasets/india_trade_data/2010_2021_HS2_export.csv&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_exp</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Rows</span><span class="p">:</span><span class="w"> </span><span class="mi">184755</span><span class="w"> </span><span class="nx">Columns</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="err">##</span><span class="w"> </span><span class="err">──</span><span class="w"> </span><span class="nx">Column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="err">────────────────────────────────────────────────────────</span>
<span class="err">##</span><span class="w"> </span><span class="nx">Delimiter</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;,&quot;</span>
<span class="err">##</span><span class="w"> </span><span class="nx">chr</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="w"> </span><span class="nx">HSCode</span><span class="p">,</span><span class="w"> </span><span class="nx">Commodity</span><span class="p">,</span><span class="w"> </span><span class="nx">country</span>
<span class="err">##</span><span class="w"> </span><span class="nx">dbl</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">):</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">year</span>
<span class="err">##</span><span class="w"> </span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="err">`</span><span class="nx">spec</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">retrieve</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">full</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Specify</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="err">`</span><span class="nx">show_col_types</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">FALSE</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quiet</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nf">read_csv</span><span class="p">(</span><span class="s">&quot;~/.datasets/india_trade_data/2010_2021_HS2_import.csv&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_imp</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Rows</span><span class="p">:</span><span class="w"> </span><span class="mi">101051</span><span class="w"> </span><span class="nx">Columns</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="err">##</span><span class="w"> </span><span class="err">──</span><span class="w"> </span><span class="nx">Column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="err">────────────────────────────────────────────────────────</span>
<span class="err">##</span><span class="w"> </span><span class="nx">Delimiter</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;,&quot;</span>
<span class="err">##</span><span class="w"> </span><span class="nx">chr</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="w"> </span><span class="nx">HSCode</span><span class="p">,</span><span class="w"> </span><span class="nx">Commodity</span><span class="p">,</span><span class="w"> </span><span class="nx">country</span>
<span class="err">##</span><span class="w"> </span><span class="nx">dbl</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">):</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">year</span>
<span class="err">##</span><span class="w"> </span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="err">`</span><span class="nx">spec</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">retrieve</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">full</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">specification</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span>
<span class="err">##</span><span class="w"> </span><span class="nx">ℹ</span><span class="w"> </span><span class="nx">Specify</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">column</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="err">`</span><span class="nx">show_col_types</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">FALSE</span><span class="err">`</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quiet</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">message</span><span class="p">.</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">df_hs2_exp</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">trade_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;export&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_exp</span>
<span class="n">df_hs2_imp</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">trade_direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;import&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2_imp</span>

<span class="n">df_hs2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">bind_rows</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">df_hs2_exp</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2_imp</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">    </span><span class="nf">is.na</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">    </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">value</span>
<span class="w">  </span><span class="p">),</span>
<span class="w">  </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
<span class="w">  </span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">case_when</span><span class="p">(</span>
<span class="w">    </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;U S A&quot;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;United states of America&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">country</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;U K&quot;</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="s">&quot;United Kingdom&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="kc">TRUE</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">country</span>
<span class="w">  </span><span class="p">))</span>

<span class="n">indicators</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;gdp&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;NY.GDP.MKTP.CD&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># GDP in current dollars</span>
<span class="w">                </span><span class="s">&quot;population&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SP.POP.TOTL&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1"># population</span>
<span class="w">                </span><span class="s">&quot;land_area&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;EN.LAND.TOTL&quot;</span><span class="w"> </span><span class="c1"># total land</span>
<span class="w">                </span><span class="p">)</span>
<span class="nf">WDI</span><span class="p">(</span><span class="n">indicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">indicators</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2010</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2021</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">wb_df</span>

<span class="n">df_hs2</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">iso3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">country_name</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="o">=</span><span class="s">&quot;ISO3&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_hs2</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>##<span class="w"> </span><span class="nv">Some</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">IDs</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">no</span><span class="w"> </span><span class="nv">match</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">one</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">more</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">requested</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">naming</span><span class="w"> </span><span class="nv">conventions</span>,<span class="w"> </span><span class="nv">NA</span><span class="w"> </span><span class="nv">returned</span>.
##<span class="w"> </span><span class="nv">Multiple</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">IDs</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">been</span><span class="w"> </span><span class="nv">matched</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">same</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">name</span>.
##<span class="w"> </span><span class="nv">There</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">low</span><span class="w"> </span><span class="nv">confidence</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">matching</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">some</span><span class="w"> </span><span class="nv">country</span><span class="w"> </span><span class="nv">names</span>,<span class="w"> </span><span class="nv">NA</span><span class="w"> </span><span class="nv">returned</span>.
##<span class="w"> </span>
##<span class="w"> </span><span class="nv">Set</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">verbose</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">TRUE</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">more</span><span class="w"> </span><span class="nv">details</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">left_join</span><span class="p">(</span><span class="n">df_hs2</span><span class="p">,</span><span class="w"> </span><span class="n">wb_df</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;iso3c&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;year&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="n">Commodity</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country.y</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">,</span><span class="w"> </span><span class="n">iso3c</span><span class="p">,</span><span class="w"> </span><span class="n">gdp</span><span class="p">,</span><span class="w"> </span><span class="n">population</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">group_by</span><span class="p">(</span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">summarise</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="n">gdp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gdp</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">population</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">population</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">.groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;drop&quot;</span><span class="p">)</span>

<span class="nf">rm</span><span class="p">(</span><span class="n">df_exp</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2_exp</span><span class="p">,</span><span class="w"> </span><span class="n">df_hs2_imp</span><span class="p">,</span><span class="w"> </span><span class="n">df_imp</span><span class="p">,</span><span class="w"> </span><span class="n">wb_df</span><span class="p">)</span>
</code></pre></div>

<p>Just for simplicity, we will stick to the HS2 files (2010-2021), and
ignore the other two (HS trade data) files that run from 2010-2018. We
will combine the two files into a single data frame with an added column
indicating direction of trade. We also interpret NAs in the <code>value</code>
column to mean that there was no trade, and replace those with 0.</p>
<p>To make this something of a modelling challenge, we have enhanced the
data with some information about the countries India is trading with,
like the GDP. We downloaded GDP data from the World Bank with the <code>WDI</code>
package. Then, we did a left join onto the Indian trade data on country
and year, by first converting the countries in the Indian trade to their
ISO3 codes via the <code>countries</code> package.</p>
<p>The data frame we now have will serve as the basis for us to explore
tidy modeling and conformal prediction in R.</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">sample_n</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">## # A tibble: 10 × 6</span>
<span class="c1">##    country             year trade_direction   value           gdp population</span>
<span class="c1">##    &lt;chr&gt;              &lt;int&gt; &lt;chr&gt;             &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="c1">##  1 Honduras            2017 export           146.    23136247991.    9626842</span>
<span class="c1">##  2 West Bank and Gaza  2020 import             0.15  15531700000     4803269</span>
<span class="c1">##  3 Maldives            2017 export           217.     4816426257.     472442</span>
<span class="c1">##  4 Cote d&#39;Ivoire       2017 export           512.    52512343997.   24848016</span>
<span class="c1">##  5 Kyrgyz Republic     2015 import             1.78   6678177512.    5956900</span>
<span class="c1">##  6 Faroe Islands       2019 export             0.91   3266432734.      51681</span>
<span class="c1">##  7 Sri Lanka           2016 export          3913.    88012282206.   21425494</span>
<span class="c1">##  8 Gibraltar           2012 import             0.09           NA       32160</span>
<span class="c1">##  9 Namibia             2016 export            89.9   10722018732.    2323352</span>
<span class="c1">## 10 Iran, Islamic Rep.  2021 import           463.   359096907772.   87923432</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nf">ggplot</span><span class="p">({</span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">na.omit</span><span class="p">()},</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">value</span><span class="p">},</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_x_log10</span><span class="p">()</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_tufte</span><span class="p">()</span>
</code></pre></div>

<p><img alt="center" src="/figures/tidymodconformal/unnamed-chunk-3-1.png"></p>
<h2>Tidy modeling in R</h2>
<p>Since the quantitative columns like <code>value</code>, <code>gdp</code> and <code>population</code> vary
by orders of magnitude over the data, it probably makes sense to log
transform them. To deal with 0 values, we add 1 to all the values, and
omit rows which have any data missing. Now we split the data into
training and test using built in functions from the <code>rsample</code> package,
making sure that the distribution of the value column is similar in all
our data splits using the strata argument.</p>
<div class="highlight"><pre><span></span><code><span class="nf">set.seed</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>

<span class="n">trade_split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">initial_validation_split</span><span class="p">({</span><span class="n">df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">na.omit</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.factor</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">value</span><span class="m">+1</span><span class="p">))},</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.2</span><span class="p">),</span><span class="w"> </span><span class="n">strata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="n">trade_split</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>## &lt;Training/Validation/Testing/Total&gt;
## &lt;2856/952/952/4760&gt;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">train_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">training</span><span class="p">(</span><span class="n">trade_split</span><span class="p">)</span>
<span class="n">val_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">validation</span><span class="p">(</span><span class="n">trade_split</span><span class="p">)</span>
<span class="n">test_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">testing</span><span class="p">(</span><span class="n">trade_split</span><span class="p">)</span>


<span class="n">trade_simple_regression</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>
<span class="w">  </span><span class="nf">recipe</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">train_df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">      </span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">country</span><span class="p">)})</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">step_naomit</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">step_log</span><span class="p">(</span><span class="n">gdp</span><span class="p">,</span><span class="w"> </span><span class="n">population</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">step_dummy</span><span class="p">(</span><span class="nf">all_nominal_predictors</span><span class="p">())</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">step_normalize</span><span class="p">(</span><span class="n">gdp</span><span class="p">,</span><span class="w"> </span><span class="n">population</span><span class="p">)</span>
</code></pre></div>

<h3>Linear model</h3>
<p>As a first baseline, always best ton begin with a simple, interpretable
linear model.</p>
<div class="highlight"><pre><span></span><code><span class="n">linear_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">linear_reg</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">set_engine</span><span class="p">(</span><span class="s">&quot;lm&quot;</span><span class="p">)</span><span class="w"> </span>

<span class="n">linear_workflow</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">workflow</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span>
<span class="w">  </span><span class="nf">add_recipe</span><span class="p">(</span><span class="n">trade_simple_regression</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">add_model</span><span class="p">(</span><span class="n">linear_model</span><span class="p">)</span>

<span class="n">linear_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="n">linear_workflow</span><span class="p">,</span><span class="w"> </span><span class="n">train_df</span><span class="p">)</span>

<span class="n">linear_fit</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">tidy</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">arrange</span><span class="p">(</span><span class="n">p.value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1">## # A tibble: 5 × 5</span>
<span class="c1">##   term                   estimate std.error statistic   p.value</span>
<span class="c1">##   &lt;chr&gt;                     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="c1">## 1 (Intercept)               4.82     0.0989     48.8  0        </span>
<span class="c1">## 2 gdp                       1.67     0.0472     35.5  1.30e-228</span>
<span class="c1">## 3 population                0.826    0.0471     17.5  1.63e- 65</span>
<span class="c1">## 4 trade_direction_import   -0.417    0.0557     -7.49 9.33e- 14</span>
<span class="c1">## 5 year_X2021                0.278    0.136       2.05 4.03e-  2</span>
</code></pre></div>

<p>Now, let us make some predictions on the validation data.</p>
<div class="highlight"><pre><span></span><code><span class="n">trade_reg_metrics</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">metric_set</span><span class="p">(</span><span class="n">rmse</span><span class="p">,</span><span class="w"> </span><span class="n">rsq</span><span class="p">,</span><span class="w"> </span><span class="n">mae</span><span class="p">)</span>
<span class="n">linear_test_preds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">linear_fit</span><span class="p">,</span><span class="w"> </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_df</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="n">test_df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="c1"># linear_val_preds |&gt; head()</span>
<span class="nf">trade_reg_metrics</span><span class="p">(</span><span class="n">linear_test_preds</span><span class="p">,</span><span class="w"> </span><span class="n">truth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">transmute</span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.metric</span><span class="p">,</span><span class="w"> </span><span class="n">linear_model_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.estimate</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">linear_test_perf</span>
</code></pre></div>

<h3>Regression with XGBoost</h3>
<p>We will now use the same modules of the parsnip package with XGBoost,
since this is more likely to be used in production usecases. Could
hardly be easier.</p>
<div class="highlight"><pre><span></span><code><span class="n">xgb_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">boost_tree</span><span class="p">(</span><span class="n">mtry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5000</span><span class="p">,</span><span class="w"> </span><span class="n">min_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">,</span><span class="w"> </span><span class="n">tree_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">learn_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.01</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">set_engine</span><span class="p">(</span><span class="s">&quot;xgboost&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">set_mode</span><span class="p">(</span><span class="s">&quot;regression&quot;</span><span class="p">)</span>

<span class="n">xgb_workflow</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">workflow</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span>
<span class="w">  </span><span class="nf">add_recipe</span><span class="p">(</span><span class="n">trade_simple_regression</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">add_model</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">)</span>

<span class="n">xgb_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="n">xgb_workflow</span><span class="p">,</span><span class="w"> </span><span class="n">train_df</span><span class="p">)</span>

<span class="n">xgb_test_preds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">xgb_fit</span><span class="p">,</span><span class="w"> </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_df</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="n">test_df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="nf">trade_reg_metrics</span><span class="p">(</span><span class="n">xgb_test_preds</span><span class="p">,</span><span class="w"> </span><span class="n">truth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">transmute</span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.metric</span><span class="p">,</span><span class="w"> </span><span class="n">xgb_model_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.estimate</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">xgb_test_perf</span>
<span class="nf">left_join</span><span class="p">(</span><span class="n">linear_test_perf</span><span class="p">,</span><span class="w"> </span><span class="n">xgb_test_perf</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> Joining with `by = join_by(metric)`
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> # A tibble: 3 × 3
<span class="gu">##</span>   metric linear_model_test xgb_model_test
<span class="gu">##</span>   &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt;
<span class="gu">##</span> 1 rmse               1.48           1.18 
<span class="gu">##</span> 2 rsq                0.720          0.821
<span class="gu">##</span> 3 mae                1.13           0.874
</code></pre></div>

<h3>Multiclass classification</h3>
<p>Here, we will add back the country column and widen the data frame to
show value of goods imported and exported by from this country, and try
to predict the country based on population, GDP, and trade with India.</p>
<div class="highlight"><pre><span></span><code><span class="nf">spread</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trade_direction</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">na.omit</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.factor</span><span class="p">(</span><span class="n">country</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">year</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">df_classification</span>

<span class="n">trade_class_split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">initial_split</span><span class="p">(</span><span class="n">df_classification</span><span class="p">,</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.6</span><span class="p">),</span><span class="w"> </span><span class="n">strata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>## Warning: Too little data to stratify.
## • Resampling will be unstratified.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">class_train_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">training</span><span class="p">(</span><span class="n">trade_class_split</span><span class="p">)</span>
<span class="n">class_test_df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">testing</span><span class="p">(</span><span class="n">trade_class_split</span><span class="p">)</span>

<span class="n">trade_simple_classification</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span>
<span class="w">  </span><span class="nf">recipe</span><span class="p">(</span><span class="n">country</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_train_df</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">step_naomit</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">step_log</span><span class="p">(</span><span class="n">gdp</span><span class="p">,</span><span class="w"> </span><span class="n">population</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">step_normalize</span><span class="p">(</span><span class="nf">all_numeric_predictors</span><span class="p">())</span>

<span class="n">xgb_class_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">boost_tree</span><span class="p">(</span><span class="n">mtry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">min_n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">tree_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">learn_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.01</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">set_engine</span><span class="p">(</span><span class="s">&quot;xgboost&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">set_mode</span><span class="p">(</span><span class="s">&quot;classification&quot;</span><span class="p">)</span>

<span class="n">xgb_class_workflow</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">workflow</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span>
<span class="w">  </span><span class="nf">add_recipe</span><span class="p">(</span><span class="n">trade_simple_classification</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">add_model</span><span class="p">(</span><span class="n">xgb_class_model</span><span class="p">)</span>

<span class="n">xgb_class_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="n">xgb_class_workflow</span><span class="p">,</span><span class="w"> </span><span class="n">class_train_df</span><span class="p">)</span>

<span class="n">xgb_class_test_preds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">xgb_class_fit</span><span class="p">,</span><span class="w"> </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">class_test_df</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="n">class_test_df</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="n">country</span><span class="p">))</span>
<span class="n">class_metrics</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">metric_set</span><span class="p">(</span><span class="n">accuracy</span><span class="p">,</span><span class="w"> </span><span class="n">mcc</span><span class="p">)</span>
<span class="nf">class_metrics</span><span class="p">(</span><span class="n">xgb_class_test_preds</span><span class="p">,</span><span class="w"> </span><span class="n">truth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_class</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">transmute</span><span class="p">(</span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.metric</span><span class="p">,</span><span class="w"> </span><span class="n">xgb_class_validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.estimate</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">xgb_class_perf</span>
<span class="n">xgb_class_perf</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> # A tibble: 2 × 2
<span class="gu">##</span>   metric   xgb_class_validation
<span class="gu">##</span>   &lt;chr&gt;                   &lt;dbl&gt;
<span class="gu">##</span> 1 accuracy                0.598
<span class="gu">##</span> 2 mcc                     0.597
</code></pre></div>

<p>An accuracy of 60% for a messy classification problem with 208 classes
is not too shabby at all, but adding any notion of confidence/coverage
to a particular prediction is difficult (even if we have some kind of
un-calibrated probability given by XGBoost), which is where conformal
prediction comes in.</p>
<h2>Conformal prediction</h2>
<p>In what follows, will follow the notation of Ryan Tibshirani (son of the
redoubtable Rob Tibshirani), see the reading list above for a link to
his notes.</p>
<h3>Why conformal prediction</h3>
<p>Machine learning models making point predictions are not telling us how
confident they are about those numbers, and even when we can get a
confidence interval (for a linear regression), or a probability like
score (for a classification), we cannot easily say (if at all) what the
probability is of finding the true value of an out of set data point is,
in the confidence intervals or the first few most probable values
predicted by a classifier.</p>
<p>Very often, a decision about what to do and how to do it depends
crucially on how sure we are of the prediction, and we would like very
much to know how sure we can be that the prediction falls in a certain
finite range.</p>
<p>I see the Bayesians wildly waving their hands, and I'll confess my sins
and say I'm identify as a Bayesian myself. However, the selection of
priors for model parameters is a shaky business, and untenable in any
careful artisanal sense for a large black box model. Besides, Bayesian
MCMC is computationally expensive and gets more so as model sizes
increase. Furthermore, getting a prediction distribution is also
expensive as we run the model forward drawing from the joint
distribution of parameters to get an empirical distribution of
predictions on which we can then make some probabilistic statements.</p>
<p>While bayesian inferences gives us a lot (especially if we are
interested in what part of the parameter space seems to describe the
world), it is over engineered in terms of just attaching interpretable
uncertainty statements to model predictions.</p>
<p>The field of conformal predicton - on the other hand - uses a notion of
coverage, and the goal is to enhance point predictions with sets of
predictions that are guranteed (given al available data) to contain the
true value with a certain probability.</p>
<h3>Conformal basics - regression</h3>
<p>So if we have a set of <span class="math">\(n\)</span> vectors each of <span class="math">\(d\)</span> dimensions <span class="math">\(\{X_i\}\)</span> (so
<span class="math">\(X_i\)</span> is in <span class="math">\(\mathbb{R}^d\)</span>) where <span class="math">\(i \in [1,n]\)</span>, each of which is
associated with an outcome <span class="math">\(Y_i\)</span> in <span class="math">\(\mathbb{R}\)</span>, given a new prediction
vector <span class="math">\(X_{n+1}\)</span>, we want to obtain a prediction band
<span class="math">\(\hat{C}: X \rightarrow \{\text{subset of } \mathbb{R}\}\)</span> such that we
can guarantee that the probability of <span class="math">\(Y_{n+1}\)</span> falling within the
prediction band is greater than some threshold, </p>
<div class="math">$$
\mathbb{P}(Y_{n+1} \in \hat{C}(X_{n+1})) \geq 1-\alpha,
$$</div>
<p> for a particular <span class="math">\(\alpha \in (0,1)\)</span>.</p>
<p>We - of course - would like the prediction bands to be narrower if its
"easy" to predict the <span class="math">\(Y\)</span>s from the <span class="math">\(X\)</span>s, and we would like to do this
with a finite data set and not much compute.</p>
<p>Surprisingly, this is plausible, under the assumption that the data
(even the new data) are "exchangeable", which is to say that their joint
distribution is invariant under permutations. This is a rather weaker
assumption from the IID assumptions often made. Further more, our
methods will not depend on the model parameters or reality having any
specific distribution, which is a huge advantage over Bayesian
techniques.</p>
<p>There are many ways to construct the prediction band, or to extend a
point prediction to a prediction band, we will now discuss the simplest
of these in the context of regression.</p>
<h4>Split conformal prediction</h4>
<p>First we note a basic property of a series of numbers <span class="math">\([Y_1, .., Y_n]\)</span>
drawn from some distribution. If another number <span class="math">\(Y_{n+1}\)</span> is drawn from
the same distribution, </p>
<div class="math">$$
\mathbb{P}\left(Y_{n+1}\text{ is among the smallest } \lceil (1-\alpha)(n+1) \rceil\text{ numbers in }[Y_1,..,Y_n]\right) \geq (1-\alpha),
$$</div>
<p> which gives us a way to order a finite list of numbers such that
another similar number has a certain probability <span class="math">\((1-\alpha)\)</span> of falling
within the first <span class="math">\(\lceil (1-\alpha)(n+1) \rceil\)</span> numbers of that list.
Thus, by defining </p>
<div class="math">$$
\hat{q_n} = \lceil (1-\alpha)(n+1) \rceil \text{ smallest of } Y_1 .. Y_n,
$$</div>
<p> gives us a one sided prediction interval <span class="math">\((-\infty, \hat{q}_n]\)</span> where
<span class="math">\(\mathbb{P}(Y_{n+1} \leq \hat{q}_n) \geq (1-\alpha)\)</span>. Using similar
arguments to derive an upper bound, we have, 
</p>
<div class="math">$$
\mathbb{P}(Y_{n+1} \leq \hat{q}_n) \in \left[1-\alpha, 1-\alpha + \frac{1}{n+1}\right).
$$</div>
<p><strong>The recipe</strong></p>
<p>We will now see how we can apply these inequalities to get some idea of
uncertainty and coverage gurantees in regression problems.</p>
<ol>
<li>Split the training set (<span class="math">\(n\)</span> rows) into two sets:<ol>
<li>The <em>proper</em> training set <span class="math">\(D_1\)</span> with <span class="math">\(n_1\)</span> rows</li>
<li>The <em>calibration</em> set <span class="math">\(D_2\)</span> with <span class="math">\(n_2 = n-n_1\)</span> rows</li>
</ol>
</li>
<li>Train a point prediction model/function <span class="math">\(\hat{f}_{n_1}\)</span> on <span class="math">\(D_1\)</span>.</li>
<li>Calculate the residuals <span class="math">\(R\)</span> on the calibration set,
    <div class="math">$$R_i = |Y_i - \hat{f}_{n1}(X_i)|, \text{    }i \in D_2.$$</div>
</li>
<li>Calculate the conformal quantile <span class="math">\(\hat{q}_{n_2}\)</span>,
    <div class="math">$$\hat{q}_{n_2} = \lceil (1-\alpha)(n_2+1) \rceil \text{ smallest of } R_i, i \in D_2. $$</div>
</li>
<li>The, the desired prediction band is given by,
    <div class="math">$$\hat{C}_n(x) = [\hat{f}_{n_1} - \hat{q}_{n_2}, \hat{f}_{n_1} + \hat{q}_{n_2}],$$</div>
    where we have a coverage guarantee, 
    <div class="math">$$\mathbb{P}\left(Y_{n+1}\in\hat{C}_n(X_{n+1} | D_1)\right) \in \left[1-\alpha, 1-\alpha+\frac{1}{n_2+1} \right).$$</div>
</li>
</ol>
<p>Note that there is nothing special about residuals, we can define any negatively oriented (smaller is better) conformity score <span class="math">\(V(D_2, \hat{f}_{n_1})\)</span> that would work just as well to give a prediction band such that,
</p>
<div class="math">$$
\hat{C}_n(x) = \left\{ y : V(x,y,\hat{f}_{n_1}) \leq  \lceil (1-\alpha)(n+1) \rceil \text{ smallest of the } \{V(D_2, \hat{f}_{n_1})\}\right\}.
$$</div>
<p>Now, we will revisit our initial regression problem and see what conformal prediction can do for us. This is what our xgboost model looks like when plotted against the test values.  </p>
<div class="highlight"><pre><span></span><code><span class="nf">ggplot</span><span class="p">({</span><span class="nf">bind_cols</span><span class="p">({</span><span class="n">xgb_test_preds</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="n">.pred</span><span class="p">)},</span><span class="w"> </span><span class="n">test_df</span><span class="p">)})</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_tufte</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> `geom_smooth()` using method = &#39;loess&#39; and formula = &#39;y ~ x&#39;
</code></pre></div>

<p><img alt="center" src="/figures/tidymodconformal/unnamed-chunk-9-1.png"></p>
<p>Now, we will use the <code>probably::int_conformal_split</code> function to estimate the prediction bands at the 90% level, and we will use the validation set <code>val_df</code> that we have kept aside and never used as the calibration set for this.  </p>
<div class="highlight"><pre><span></span><code><span class="n">split_con</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">int_conformal_split</span><span class="p">(</span><span class="n">xgb_fit</span><span class="p">,</span><span class="w"> </span><span class="n">val_df</span><span class="p">)</span>
<span class="n">test_split_result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">split_con</span><span class="p">,</span><span class="w"> </span><span class="n">test_df</span><span class="p">,</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">test_split_result</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_upper</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#fcba03&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_lower</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#fcba03&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_tufte</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> `geom_smooth()` using method = &#39;loess&#39; and formula = &#39;y ~ x&#39;
<span class="gu">##</span> `geom_smooth()` using method = &#39;loess&#39; and formula = &#39;y ~ x&#39;
<span class="gu">##</span> `geom_smooth()` using method = &#39;loess&#39; and formula = &#39;y ~ x&#39;
</code></pre></div>

<p><img alt="center" src="/figures/tidymodconformal/unnamed-chunk-10-1.png"></p>
<p>The interpretation that conformal prediction gives us for our prediction interval is that we would expect 90% (since that is the level we chose) of actual values to be within the interval computed based on our calibration set. Let us see how we do on coverage on our test set (we would expect it to be around 90%)</p>
<div class="highlight"><pre><span></span><code><span class="n">test_split_result</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">within_band</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">.pred_lower</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">.pred_upper</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">summarise</span><span class="p">(</span><span class="n">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">within_band</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>## # A tibble: 1 × 1
##   coverage
##      &lt;dbl&gt;
## 1     89.9
</code></pre></div>

<p>Excellent. </p>
<p>While this is an encouraging result, there are clearly some improvements needed:</p>
<ol>
<li>The prediction bands are based on the calibration set which was just 20% of the training set. If we use cross validation, we could get residuals for the entire training set and use those to calibrate the prediction bands.</li>
<li>The width of the prediction band seems constant through the entire range of values where as the points outside the range seem to occur (in this particular case) in the low and mid ranges. In general, it is reasonable to expect that the model will do better in some areas than in others, and the prediction band should reflect this, being wider in areas where the model is worse. </li>
</ol>
<p>We first address the first point, and deal with the slightly more complex issue of adaptive conformal prediction in a subsequent section. </p>
<h4>Split conformal prediction with CV</h4>
<div class="highlight"><pre><span></span><code><span class="n">ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">control_resamples</span><span class="p">(</span><span class="n">save_pred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">extract</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="c1"># this line ensures out of sample preds are also stored in the CV process</span>

<span class="n">trade_reg_folds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">vfold_cv</span><span class="p">({</span><span class="nf">bind_rows</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span><span class="w"> </span><span class="n">val_df</span><span class="p">)},</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="c1"># 10 fold CV</span>

<span class="n">xgb_resample</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">xgb_workflow</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">fit_resamples</span><span class="p">(</span><span class="n">trade_reg_folds</span><span class="p">,</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">)</span>

<span class="nf">collect_metrics</span><span class="p">(</span><span class="n">xgb_resample</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> # A tibble: 2 × 6
<span class="gu">##</span>   .metric .estimator  mean     n std_err .config             
<span class="gu">##</span>   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
<span class="gu">##</span> 1 rmse    standard   1.15     10 0.0181  Preprocessor1_Model1
<span class="gu">##</span> 2 rsq     standard   0.833    10 0.00620 Preprocessor1_Model1
</code></pre></div>

<p>Now we again use the <code>probably</code> package to estimate the prediction band.</p>
<div class="highlight"><pre><span></span><code><span class="n">cv_con</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">int_conformal_cv</span><span class="p">(</span><span class="n">xgb_resample</span><span class="p">)</span>
<span class="n">test_cv_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">cv_con</span><span class="p">,</span><span class="w"> </span><span class="n">test_df</span><span class="p">,</span><span class="w"> </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">test_cv_results</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_upper</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#fcba03&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_lower</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#fcba03&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_tufte</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> `geom_smooth()` using method = &#39;loess&#39; and formula = &#39;y ~ x&#39;
<span class="gu">##</span> `geom_smooth()` using method = &#39;loess&#39; and formula = &#39;y ~ x&#39;
<span class="gu">##</span> `geom_smooth()` using method = &#39;loess&#39; and formula = &#39;y ~ x&#39;
</code></pre></div>

<p><img alt="center" src="/figures/tidymodconformal/unnamed-chunk-13-1.png"></p>
<div class="highlight"><pre><span></span><code><span class="n">test_cv_results</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">within_band</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">.pred_lower</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">.pred_upper</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">summarise</span><span class="p">(</span><span class="n">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">within_band</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>## # A tibble: 1 × 1
##   coverage
##      &lt;dbl&gt;
## 1     89.6
</code></pre></div>

<h4>Full conformal prediction</h4>
<p>Full conformal prediction is a delightfully simple and computationally impossible (except in some rare cases that I have been assured do exist) idea that is worth glancing at. </p>
<ol>
<li>Use the entire training set (the proper training set as well as the calibration set are included) <span class="math">\(D_n  = D_{1}\cup D_{2}\)</span> such that <span class="math">\((X_i, Y_i) \in D_n\)</span>.  </li>
<li>When there is a new predictor <span class="math">\(x \in \mathbb{R}^d\)</span> available, evaluate a possible outcome <span class="math">\(y \in \mathbb{R}\)</span> by training the model on <span class="math">\(D_n\)</span> augmented with <span class="math">\((x,y)\)</span>, to get <span class="math">\(\hat{f}_{D_n\cup(x,y)}\)</span>, and calculating the residual <span class="math">\(R^{x,y} = |y - \hat{f}_{D_n\cup(x,y)}(x)|\)</span>.</li>
<li>We do this (augment the training set with one point <span class="math">\((x,y)\)</span>, and train the model on this, and calculate the residual) <strong>for all possible <span class="math">\(y\in \mathbb{R}\)</span></strong>, and then define the prediction band to be,
<div class="math">$$\hat{C}(x) = \left\{y: R^{(x,y)} \leq \lceil(1-\alpha)(n+1\rceil) \text{ smallest of } \underbrace{R_1, .. R_n}_{\text{training set residuals}}   \right\}. $$</div>
Its clear that it is extremely computationally expensive (and hopelessly impractical) to search through the space of all possible <span class="math">\(y\)</span> and to train the model on each one. </li>
</ol>
<p>Keeping this aside, now, we address the second point raised earlier, that of adaptive prediction bands.</p>
<h4>Adaptive conformal prediction</h4>
<p>To obtain adaptive prediction bands, we use a method called Conformalized Quantile Regression (CQR). Usually (for example, when minimising RMSE) we are estimating the expected value of the response variable given predictors. Quantile regression (<a href="https://cran.r-project.org/web/packages/quantreg/vignettes/rq.pdf">see the package <code>quantreg</code></a>) tries to estimate a particular quantile <span class="math">\(\tau\)</span> of the response variable instead of the mean, given some predictors. We denote a model estimating the <span class="math">\(\tau\)</span> quantile of the outcome variable by <span class="math">\(\hat{f}^{\tau}_n\)</span> where <span class="math">\(n\)</span> is the number of examples in the training set. </p>
<p><strong>CQR recipe</strong></p>
<ol>
<li>On the proper training set <span class="math">\(D_1\)</span> with <span class="math">\(n_1\)</span> examples as before, we train two quantile regression models <span class="math">\(\hat{f}^{\alpha/2}_{n_1}\)</span> and <span class="math">\(\hat{f}^{1-\alpha/2}_{n_1}\)</span>. What we are doing here is just taking the upper and lower limits of the prediction band (remember, we define the prediction band by saying that we want to have a coverage probability of <span class="math">\((1-\alpha)\)</span>, which means <span class="math">\(\alpha/2\)</span> from below and <span class="math">\(1-\alpha/2\)</span> from above are excluded).</li>
<li>The calibration test scores are defined by,
<div class="math">$$R_i = \text{max}\left[\hat{f}^{\alpha/2}_{n_1}(X_i)-Y_i, Y_i - \hat{f}^{1-\alpha/2}_{n_1}(X_i)   \right], \text{ } i \in D_2.$$</div>
</li>
<li>As before, $\hat{q}_{n_2} = \lceil (1-\alpha)(n_2+1) \rceil \text{ smallest of } R_i, i \in D_2 $, and the prediction band is given by,
<div class="math">$$\hat{C}_n(x) = \left[ \hat{f}^{\alpha/2}_{n_1}(x) - \hat{q}_{n_2},  \hat{f}^{1-\alpha/2}_{n_1}(x)+\hat{q}_{n_2} \right].$$</div>
The adaptivity of the prediction interval comes the estimates of the quantiles by the quantile regression model. </li>
</ol>
<p>Lets see an example of CQR in action using the <code>probably</code> package using the training and calibration sets, which uses quantile regression forests which are expected to be spectacularly bad for extrapolated data, but should do well otherwise.</p>
<div class="highlight"><pre><span></span><code><span class="n">cqr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">int_conformal_quantile</span><span class="p">(</span>
<span class="w">  </span><span class="n">xgb_fit</span><span class="p">,</span>
<span class="w">  </span><span class="n">train_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">train_df</span><span class="p">,</span>
<span class="w">  </span><span class="n">cal_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val_df</span><span class="p">,</span>
<span class="w">  </span><span class="n">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span>
<span class="w">  </span><span class="n">ntree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span>
<span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Error</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="err">`</span><span class="nx">quant_train</span><span class="p">()</span><span class="err">`</span><span class="p">:</span>
<span class="err">##</span><span class="w"> </span><span class="p">!</span><span class="w"> </span><span class="nx">The</span><span class="w"> </span><span class="kn">package</span><span class="w"> </span><span class="s">&quot;quantregForest&quot;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">compute</span><span class="w"> </span><span class="nx">quantiles</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">test_cqr_results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">cqr</span><span class="p">,</span><span class="w"> </span><span class="n">test_df</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">bind_cols</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>## Error in eval(expr, envir, enclos): object &#39;cqr&#39; not found
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nf">ggplot</span><span class="p">(</span><span class="n">test_cqr_results</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.25</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_upper</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#fcba03&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred_lower</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#fcba03&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.pred</span><span class="p">),</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;#2842b5&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme_tufte</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> Error in eval(expr, envir, enclos): object &#39;test_cqr_results&#39; not found
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">test_cqr_results</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">mutate</span><span class="p">(</span><span class="n">within_band</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">.pred_lower</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">.pred_upper</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span>
<span class="w">  </span><span class="nf">summarise</span><span class="p">(</span><span class="n">coverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">mean</span><span class="p">(</span><span class="n">within_band</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="gu">##</span> Error in eval(expr, envir, enclos): object &#39;test_cqr_results&#39; not found
</code></pre></div>

<p>Honestly, for our data at least, that looks <strong>so much worse</strong> than just simple CV based split conformal prediction. Need to look into finding / implementing a better CQR method. <strong>[TODO]</strong> Quantile regression with XGBoost</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://www.linkedin.com/in/pbhogale"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://github.com/pbhogale"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./tidymodels-and-conformal-prediction.html">"Tidymodels and conformal prediction"</a></li>
    <li class="list-group-item"><a href="./r-torch-and-the-little-book-of-deep-learning.html">"R, Torch, and the little book of deep learning"</a></li>
    <li class="list-group-item"><a href="./becoming-a-data-scientist-an-opinionated-take-in-2020.html">"Becoming a Data Scientist : an opinionated take in 2020"</a></li>
    <li class="list-group-item"><a href="./linear-and-mixed-integer-programming.html">"Linear and mixed integer programming"</a></li>
    <li class="list-group-item"><a href="./the-invisible-hand.html">"The Invisible Hand"</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 pras
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>


    <script src="./theme/js/bodypadding.js"></script>


</body>
</html>